import sqlite3
import os
from config import DB_PATH

def get_db_connection():
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    return conn

def init_db():
    """Инициализация таблиц и автоматическое наполнение продуктами"""
    conn = get_db_connection()
    cur = conn.cursor()
    
    # Таблица пользователей
    cur.execute("""
    CREATE TABLE IF NOT EXISTS users (
        user_id INTEGER PRIMARY KEY,
        age INTEGER,
        weight REAL,
        height REAL,
        gender TEXT,
        activity TEXT,
        daily_norm REAL
    )
    """)

    # Таблица логов
    cur.execute("""
    CREATE TABLE IF NOT EXISTS logs (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        kcal REAL, protein REAL, fat REAL, carbs REAL,
        details TEXT, meal_name TEXT,
        date TEXT DEFAULT (date('now', 'localtime')),
        timestamp DATETIME DEFAULT (datetime('now', 'localtime'))
    )
    """)

    # Таблица продуктов
    cur.execute("""
    CREATE TABLE IF NOT EXISTS foods (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT,
        kcal REAL, protein REAL, fat REAL, carbs REAL
    )
    """)

    # --- НАПОЛНЕНИЕ БАЗЫ ---
    cur.execute("SELECT COUNT(*) FROM foods")
    count = cur.fetchone()[0]

    # Если база пустая или там старый короткий список
    if count < 100:
        cur.execute("DELETE FROM foods") # Очищаем перед заливкой
        
        big_foods_list = [
            # --- КУРИЦА И ИНДЕЙКА ---
            ('курица филе (сырое)', 113, 23.6, 1.9, 0.4),
            ('курица филе (отварное)', 137, 29.8, 1.8, 0.0),
            ('курица филе (жареное)', 165, 31.0, 4.5, 0.0),
            ('курица филе (запеченное)', 150, 28.0, 3.5, 0.0),
            ('курица гриль (с кожей)', 210, 25.0, 11.0, 0.0),
            ('куриное бедро (без кости)', 160, 20.0, 9.0, 0.0),
            ('куриное бедро (запеченное)', 185, 22.0, 10.5, 0.0),
            ('куриные крылышки', 220, 18.0, 16.0, 0.0),
            ('куриные крылышки (во фритюре)', 320, 16.0, 22.0, 12.0),
            ('куриная печень (сырая)', 140, 19.0, 6.0, 1.0),
            ('куриная печень (тушеная)', 165, 20.0, 8.5, 2.1),
            ('куриные сердечки (тушеные)', 159, 16.0, 10.0, 0.8),
            ('куриные желудки (отварные)', 130, 21.0, 4.5, 0.0),
            ('куриный рулет', 160, 18.0, 9.0, 1.5),
            ('курица карри', 140, 16.0, 7.0, 4.0),
            ('наггетсы куриные жареные', 296, 15.2, 18.1, 18.4),
            ('индейка филе (сырое)', 115, 24.0, 2.0, 0.0),
            ('индейка филе (отварное)', 130, 26.5, 2.5, 0.0),
            ('индейка филе (запеченное)', 145, 27.0, 3.8, 0.0),
            ('индейка голень', 140, 20.0, 6.0, 0.0),
            ('перепелка (тушка)', 230, 18.0, 17.0, 0.0),
            ('перепелиное яйцо (1 шт)', 158, 13.0, 11.0, 0.4),

            # --- ГОВЯДИНА, СВИНИНА, БАРАНИНА ---
            ('говядина вырезка (сырая)', 187, 22.0, 11.0, 0.0),
            ('говядина вырезка (отварная)', 220, 25.0, 13.0, 0.0),
            ('говядина (тушеная)', 195, 21.0, 12.0, 0.0),
            ('стейк рибай', 291, 24.0, 22.0, 0.0),
            ('стейк филе-миньон', 210, 26.0, 11.0, 0.0),
            ('говяжий фарш (нежирный)', 190, 19.0, 12.0, 0.0),
            ('говяжий фарш (домашний)', 250, 17.0, 20.0, 0.0),
            ('язык говяжий (отварной)', 170, 15.0, 12.0, 0.0),
            ('печень говяжья (жареная)', 199, 21.0, 10.0, 5.0),
            ('гуляш говяжий', 148, 16.0, 8.0, 3.0),
            ('телятина', 172, 19.7, 10.3, 0.0),
            ('свинина нежирная (лопатка)', 260, 16.0, 21.0, 0.0),
            ('свиная шея (сырая)', 340, 14.0, 32.0, 0.0),
            ('свиная шея (шашлык)', 280, 16.0, 24.0, 0.0),
            ('корейка свиная', 242, 17.0, 19.0, 0.0),
            ('свиной окорок', 261, 18.0, 21.0, 0.0),
            ('баранина (мякоть)', 290, 17.0, 25.0, 0.0),
            ('баранина (тушеная)', 220, 16.5, 17.0, 0.0),
            ('утка филе (с кожей)', 337, 15.8, 28.0, 0.0),
            ('гусь', 370, 16.0, 33.0, 0.0),
            ('кролик', 156, 21.0, 8.0, 0.0),
            ('оленина', 155, 23.0, 7.0, 0.0),
            ('конина', 187, 21.0, 11.0, 0.0),

            # --- КОЛБАСЫ И ДЕЛИКАТЕСЫ ---
            ('колбаса докторская', 250, 12.0, 22.0, 1.5),
            ('колбаса с/к (салями)', 470, 17.0, 44.0, 1.0),
            ('сервелат', 461, 16.0, 44.0, 0.5),
            ('сосиски молочные', 260, 11.0, 23.0, 1.5),
            ('ветчина индейка', 100, 15.0, 4.0, 1.0),
            ('бекон (сырокопченый)', 540, 37.0, 42.0, 1.4),
            ('бекон (жареный)', 620, 25.0, 58.0, 1.0),
            ('хамон', 240, 25.0, 15.0, 1.0),
            ('бастурма', 210, 33.0, 8.0, 2.0),
            ('буженина', 255, 17.0, 21.0, 0.0),
            ('паштет гусиный', 420, 11.0, 41.0, 2.0),
            ('кровяная колбаса', 379, 14.0, 35.0, 1.0),

            # --- РЫБА И МОРЕПРОДУКТЫ ---
            ('лосось семга', 208, 20.0, 13.0, 0.0),
            ('форель запеченная', 190, 20.0, 12.0, 0.0),
            ('тунец свежий', 140, 24.0, 4.0, 0.0),
            ('тунец консервированный', 100, 22.0, 1.0, 0.0),
            ('треска отварная', 82, 18.0, 0.7, 0.0),
            ('минтай запеченный', 72, 16.0, 0.9, 0.0),
            ('скумбрия копченая', 200, 18.0, 14.0, 0.0),
            ('сельдь м/с', 210, 17.0, 15.0, 0.0),
            ('сибас гриль', 97, 18.0, 3.0, 0.0),
            ('дорадо запеченная', 96, 18.0, 2.0, 0.0),
            ('креветки отварные', 95, 20.0, 1.0, 0.0),
            ('кальмары отварные', 100, 18.0, 2.0, 2.0),
            ('мидии в с/с', 77, 11.5, 2.0, 3.3),
            ('осьминог отварной', 82, 15.0, 1.0, 2.0),
            ('икра красная', 250, 31.0, 13.0, 1.0),
            ('угорь копченый', 320, 15.0, 28.0, 0.0),
            ('хек тушеный', 95, 17.0, 3.0, 0.0),
            ('камбала на пару', 85, 16.0, 2.0, 0.0),
            ('крабовые палочки', 95, 6.0, 1.0, 15.0),
            ('морской окунь', 103, 18.0, 3.3, 0.0),
            ('анчоусы в масле', 210, 28.0, 10.0, 0.0),
            ('лангустины гриль', 110, 21.0, 2.0, 0.0),

            # --- КРУПЫ И БОБОВЫЕ ---
            ('гречка (сухая)', 308, 12.6, 3.3, 57.1),
            ('гречка (отварная на воде)', 110, 4.2, 1.1, 21.0),
            ('рис белый (сухой)', 344, 6.7, 0.7, 78.9),
            ('рис белый (отварной)', 116, 2.2, 0.5, 24.9),
            ('рис бурый (сухой)', 330, 7.5, 2.0, 70.0),
            ('киноа (сухая)', 368, 14.1, 6.1, 64.2),
            ('овсянка геркулес (сухая)', 389, 16.0, 7.0, 66.0),
            ('овсяная каша (на воде)', 88, 3.0, 1.7, 15.0),
            ('макароны (тв. пшеница, сухие)', 350, 12.0, 1.5, 71.0),
            ('макароны (отварные)', 140, 5.0, 0.6, 28.0),
            ('булгур (сухой)', 342, 12.0, 1.3, 76.0),
            ('кускус (сухой)', 376, 12.8, 0.6, 77.0),
            ('чечевица (сухая)', 310, 24.0, 1.5, 50.0),
            ('нут (сухой)', 360, 19.0, 6.0, 50.0),
            ('маш (сухой)', 300, 23.5, 2.0, 46.0),
            ('фасоль белая (консерв.)', 90, 7.0, 0.5, 15.0),
            ('горох (сухой)', 300, 20.0, 2.0, 50.0),
            ('полба (сухая)', 338, 14.5, 2.4, 70.0),
            ('тофу плотный', 83, 10.0, 5.0, 1.1),
            ('фучжу (соевая спаржа сухая)', 440, 45.0, 20.0, 20.0),

            # --- ОВОЩИ, ГРИБЫ И ЗЕЛЕНЬ ---
            ('картофель (сырой)', 77, 2.0, 0.4, 16.3),
            ('картофель (отварной)', 82, 2.0, 0.4, 16.7),
            ('картофель фри', 312, 3.4, 15.5, 41.2),
            ('картофель по-деревенски', 140, 2.5, 6.0, 20.0),
            ('огурец свежий', 15, 0.8, 0.1, 2.8),
            ('помидор свежий', 18, 0.9, 0.2, 3.9),
            ('авокадо (мякоть)', 160, 2.0, 14.7, 1.8),
            ('брокколи (сырая)', 34, 2.8, 0.4, 7.0),
            ('кабачок (сырой)', 24, 0.6, 0.3, 4.6),
            ('баклажан (запеченный)', 45, 1.2, 2.0, 6.5),
            ('тыква (запеченная)', 26, 1.0, 0.1, 4.4),
            ('свекла (отварная)', 49, 1.8, 0.1, 10.8),
            ('болгарский перец', 26, 1.3, 0.1, 5.3),
            ('морковь (свежая)', 41, 0.9, 0.2, 10.0),
            ('морковь по-корейски', 110, 1.2, 8.0, 9.0),
            ('квашеная капуста', 19, 0.9, 0.1, 4.4),
            ('спаржа на пару', 22, 2.4, 0.2, 3.0),
            ('шпинат свежий', 23, 2.9, 0.4, 3.6),
            ('грибы шампиньоны (сырые)', 27, 4.3, 1.0, 0.1),
            ('грибы белые (жареные)', 160, 4.5, 14.0, 3.2),
            ('морская капуста', 24, 0.9, 0.2, 3.0),

            # --- ФРУКТЫ И ЯГОДЫ ---
            ('яблоко', 52, 0.3, 0.2, 13.8),
            ('банан', 89, 1.1, 0.3, 22.8),
            ('груша', 57, 0.4, 0.1, 15.2),
            ('апельсин', 47, 0.9, 0.1, 11.8),
            ('грейпфрут', 42, 0.8, 0.1, 11.0),
            ('киви', 61, 1.1, 0.5, 14.7),
            ('манго', 60, 0.8, 0.4, 15.0),
            ('клубника', 33, 0.7, 0.3, 7.7),
            ('голубика', 57, 0.7, 0.3, 14.5),
            ('чернослив сушеный', 240, 2.3, 0.7, 57.0),
            ('курага сушеная', 241, 3.3, 0.5, 62.0),
            ('финики сушеные', 277, 2.5, 0.5, 75.0),
            ('арбуз', 30, 0.6, 0.1, 7.5),
            ('дыня', 33, 0.6, 0.3, 7.4),

            # --- МОЛОЧНЫЕ ПРОДУКТЫ И СЫРЫ ---
            ('молоко 2.5%', 52, 3.0, 2.5, 4.7),
            ('молоко 3.2%', 60, 3.2, 3.2, 4.8),
            ('молоко миндальное (б/с)', 15, 0.5, 1.1, 0.3),
            ('кефир 1%', 40, 3.0, 1.0, 4.0),
            ('ряженка 4%', 67, 2.9, 4.0, 4.1),
            ('творог 5%', 121, 17.2, 5.0, 1.8),
            ('творог 9%', 159, 16.0, 9.0, 3.0),
            ('творог зерненый', 95, 11.0, 5.0, 2.5),
            ('йогурт греческий 0%', 57, 10.0, 0.0, 4.0),
            ('сметана 15%', 160, 2.7, 15.0, 3.0),
            ('сыр российский', 363, 23.0, 29.5, 0.0),
            ('сыр пармезан', 431, 38.0, 28.0, 4.1),
            ('сыр моцарелла', 280, 22.0, 22.0, 2.2),
            ('сыр фета', 264, 14.2, 21.3, 4.1),
            ('сыр адыгейский', 226, 16.0, 18.0, 0.0),
            ('сыр сулугуни', 285, 19.5, 22.0, 0.0),
            ('сыр бри / камамбер', 310, 20.0, 25.0, 0.5),
            ('сыр рикотта', 174, 11.2, 13.0, 3.0),
            ('сливочное масло 82.5%', 748, 0.5, 82.5, 0.8),

            # --- ФАСТФУД ---
            ('бургер классик', 254, 13.2, 12.5, 23.1),
            ('биг мак', 257, 12.0, 14.0, 20.0),
            ('шаурма с курицей', 175, 9.0, 8.5, 16.2),
            ('пицца маргарита', 210, 9.1, 8.2, 26.3),
            ('пицца пепперони', 270, 11.0, 13.0, 26.0),
            ('суши филадельфия', 145, 6.2, 6.1, 17.5),
            ('ролл калифорния', 176, 5.1, 7.2, 22.5),

            # --- СЛАДОСТИ И ДЕСЕРТЫ ---
            ('шоколад горький 70%', 540, 8.0, 43.0, 35.0),
            ('шоколад молочный', 535, 7.0, 29.7, 59.4),
            ('мед натуральный', 304, 0.3, 0.0, 82.4),
            ('зефир', 326, 0.8, 0.1, 79.8),
            ('халва подсолнечная', 523, 11.6, 29.7, 54.0),
            ('чизкейк нью-йорк', 321, 5.5, 22.5, 25.0),
            ('тирамису', 354, 4.2, 25.0, 28.0),
            ('эклер с кремом', 330, 5.4, 20.0, 32.0),
            ('мороженое пломбир', 230, 3.7, 15.0, 20.0),

            # --- НАПИТКИ ---
            ('кофе черный (б/с)', 2, 0.2, 0.0, 0.3),
            ('капучино (б/с)', 35, 2.0, 2.1, 3.1),
            ('латте (б/с)', 40, 2.6, 2.5, 4.1),
            ('чай черный/зеленый (б/с)', 1, 0.1, 0.0, 0.2),
            ('кола (классическая)', 42, 0.0, 0.0, 10.6),
            ('кола зеро', 0, 0.0, 0.0, 0.0),
            ('сок яблочный', 46, 0.4, 0.1, 11.3),
            ('пиво светлое', 43, 0.4, 0.0, 3.6),
            ('вино красное сухое', 68, 0.2, 0.0, 0.3),
            ('водка/виски (40%)', 235, 0.0, 0.0, 0.1),
            ('вода питьевая/минеральная', 0, 0.0, 0.0, 0.0),
            ('чай с сахаром (1 ч.л.)', 25, 0.1, 0.0, 6.0),

            # --- СОУСЫ И ДОБАВКИ ---
            ('майонез 67%', 624, 2.4, 67.0, 3.9),
            ('кетчуп', 110, 1.2, 0.1, 26.0),
            ('соевый соус', 53, 8.1, 0.0, 4.9),
            ('горчица', 162, 9.5, 6.4, 15.8),
            ('масло оливковое', 884, 0.0, 100.0, 0.0),

            # --- ХЛЕБ И ВЫПЕЧКА ---
            ('хлеб бородинский', 201, 6.8, 1.3, 39.8),
            ('хлеб пшеничный (батон)', 264, 7.5, 2.9, 51.0),
            ('хлеб ржаной', 259, 8.5, 3.3, 48.3),
            ('чиабатта', 262, 8.0, 1.0, 54.0),
            ('лаваш тонкий (армянский)', 236, 7.9, 1.0, 47.6),
            ('круассан классический (б/н)', 406, 8.2, 21.0, 45.8),
            ('хлебцы цельнозерновые', 310, 10.0, 2.0, 62.0),

            # --- ПРОЧЕЕ ---
            ('протеин сывороточный (порошок)', 390, 75.0, 5.0, 10.0),
            ('батончик протеиновый (60г)', 210, 20.0, 7.0, 15.0),
            ('желатин пищевой', 355, 87.2, 0.4, 0.7),
            ('водоросли нори', 200, 24.0, 0.0, 40.0),
            ('мясо краба (натуральное)', 96, 18.0, 1.5, 0.0),
            ('драгонфрут (питахайя)', 50, 1.2, 0.4, 11.0)
        ]
        
        cur.executemany("""
            INSERT INTO foods (name, kcal, protein, fat, carbs) 
            VALUES (?, ?, ?, ?, ?)
        """, big_foods_list)
        
        conn.commit()
        print(f"База данных успешно наполнена. Добавлено {len(big_foods_list)} продуктов.")

    conn.close()

# --- ПОИСК ПРОДУКТОВ ---
def search_foods(query):
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("""
        SELECT id, name, kcal, protein, fat, carbs FROM foods 
        WHERE LOWER(name) LIKE ? 
        ORDER BY LENGTH(name) ASC 
        LIMIT 10
    """, ('%' + query.lower() + '%',))
    results = cursor.fetchall()
    conn.close()
    return results

def get_food_by_id(food_id: int):
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM foods WHERE id = ?", (food_id,))
    result = cursor.fetchone()
    conn.close()
    return result

# --- ПОЛЬЗОВАТЕЛИ ---
def upsert_user_profile(user_id, gender, age, height, weight, activity_text, daily_norm):
    conn = get_db_connection()
    cur = conn.cursor()
    cur.execute("""
        INSERT OR REPLACE INTO users (user_id, age, weight, height, gender, activity, daily_norm)
        VALUES (?, ?, ?, ?, ?, ?, ?)
    """, (user_id, age, weight, height, gender, activity_text, daily_norm))
    conn.commit()
    conn.close()
    return daily_norm

def get_user_profile(user_id):
    conn = get_db_connection()
    cur = conn.cursor()
    cur.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
    user = cur.fetchone()
    conn.close()
    return user

# --- ЛОГИ (ПРИЕМЫ ПИЩИ) ---
def log_meal(user_id, kcal, p, f, c, details, meal_name="Прием пищи"):
    conn = get_db_connection()
    cur = conn.cursor()
    cur.execute("""
        INSERT INTO logs (user_id, kcal, protein, fat, carbs, details, meal_name)
        VALUES (?, ?, ?, ?, ?, ?, ?)
    """, (user_id, kcal, p, f, c, details, meal_name))
    conn.commit()
    conn.close()

def get_daily_logs(user_id):
    conn = get_db_connection()
    cur = conn.cursor()
    cur.execute("""
        SELECT kcal, protein, fat, carbs, details, meal_name,
               strftime('%H:%M', timestamp) as meal_time
        FROM logs 
        WHERE user_id = ? AND date = date('now', 'localtime')
        ORDER BY timestamp ASC
    """, (user_id,))
    rows = cur.fetchall()
    conn.close()
    return rows

def get_daily_stats(user_id):
    conn = get_db_connection()
    cur = conn.cursor()
    cur.execute("""
        SELECT SUM(kcal) as total_kcal, 
               SUM(protein) as total_prot, 
               SUM(fat) as total_fat, 
               SUM(carbs) as total_carb
        FROM logs 
        WHERE user_id = ? AND date = date('now', 'localtime')
    """, (user_id,))
    stats = cur.fetchone()
    conn.close()
    return stats

def reset_user_data(user_id):
    conn = get_db_connection()
    cur = conn.cursor()
    cur.execute("DELETE FROM users WHERE user_id = ?", (user_id,))
    cur.execute("DELETE FROM logs WHERE user_id = ?", (user_id,))
    conn.commit()
    conn.close()
    return True
def add_custom_food(name, kcal, protein, fat, carbs):
    """Добавляет пользовательский продукт в базу данных"""
    conn = get_db_connection()
    cur = conn.cursor()
    cur.execute("""
        INSERT INTO foods (name, kcal, protein, fat, carbs)
        VALUES (?, ?, ?, ?, ?)
    """, (name, kcal, protein, fat, carbs))
    conn.commit()
    conn.close()
    return True